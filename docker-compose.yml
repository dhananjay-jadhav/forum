services:
    postgres:
        image: postgres:16-alpine
        container_name: postgraphile-db
        ports:
            - '5432:5432'
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: password
            POSTGRES_DB: forum
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 5s
            timeout: 5s
            retries: 5

    # Kafka and Zookeeper for event streaming
    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: forum-zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - '2181:2181'
        healthcheck:
            test: ['CMD', 'nc', '-z', 'localhost', '2181']
            interval: 10s
            timeout: 5s
            retries: 5

    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: forum-kafka
        depends_on:
            zookeeper:
                condition: service_healthy
        ports:
            - '9092:9092'
            - '29092:29092'
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
        healthcheck:
            test: ['CMD', 'kafka-broker-api-versions', '--bootstrap-server', 'localhost:9092']
            interval: 10s
            timeout: 10s
            retries: 5

    # Kafka UI for debugging (optional)
    kafka-ui:
        image: provectuslabs/kafka-ui:latest
        container_name: forum-kafka-ui
        depends_on:
            kafka:
                condition: service_healthy
        ports:
            - '8080:8080'
        environment:
            KAFKA_CLUSTERS_0_NAME: forum-cluster
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181

    # Elasticsearch for search functionality
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:9.0.0
        container_name: forum-elasticsearch
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - 'ES_JAVA_OPTS=-Xms512m -Xmx512m'
        ports:
            - '9200:9200'
            - '9300:9300'
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        healthcheck:
            test: ['CMD-SHELL', 'curl -s http://localhost:9200/_cluster/health | grep -q green']
            interval: 10s
            timeout: 5s
            retries: 10

    # Forum API (main GraphQL API)
    # api:
    #     build:
    #         context: .
    #         dockerfile: apps/api/Dockerfile
    #     container_name: forum-api
    #     depends_on:
    #         postgres:
    #             condition: service_healthy
    #         kafka:
    #             condition: service_healthy
    #     ports:
    #         - '3000:3000'
    #     environment:
    #         NODE_ENV: production
    #         PORT: 3000
    #         DATABASE_URL: postgres://postgres:password@postgres:5432/forum
    #         JWT_SECRET: your-jwt-secret-change-in-production
    #         KAFKA_BROKERS: kafka:29092
    #         KAFKA_ENABLED: 'true'

    # Analytics API (Kafka consumer + REST API)
    # analytics-api:
    #     build:
    #         context: .
    #         dockerfile: apps/analytics-api/Dockerfile
    #     container_name: forum-analytics-api
    #     depends_on:
    #         kafka:
    #             condition: service_healthy
    #     ports:
    #         - '3002:3002'
    #     environment:
    #         NODE_ENV: production
    #         ANALYTICS_PORT: 3002
    #         KAFKA_BROKERS: kafka:29092
    #         KAFKA_ENABLED: 'true'
    #         KAFKA_GROUP_ID: analytics-api-group

    # Search API (Kafka consumer + Elasticsearch + REST API)
    # search-api:
    #     build:
    #         context: .
    #         dockerfile: apps/search-api/Dockerfile
    #     container_name: forum-search-api
    #     depends_on:
    #         kafka:
    #             condition: service_healthy
    #         elasticsearch:
    #             condition: service_healthy
    #     ports:
    #         - '3003:3003'
    #     environment:
    #         NODE_ENV: production
    #         SEARCH_PORT: 3003
    #         KAFKA_BROKERS: kafka:29092
    #         KAFKA_ENABLED: 'true'
    #         KAFKA_GROUP_ID: search-api-group
    #         ELASTICSEARCH_URL: http://elasticsearch:9200
    #         ES_INDEX_PREFIX: forum

volumes:
    postgres_data:
    elasticsearch_data:
